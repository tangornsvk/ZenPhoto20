!function(m){var a=[];function r(e){var t,a,r=[];for(a=0;a<e.length;a++)t=e[a],"object"==typeof e[a]&&(t=e[a].tag),r.push(t.toLowerCase());return r}window.setGlobalTags=function(e){a=r(e)},m.fn.tagSuggest=function(t){var d=[],C=m.extend({},{matchClass:"tagMatches",tagContainer:"span",tagWrap:"span",sort:!0,tags:null,url:null,delay:0,quoteSpecial:!1,separator:" "},t);return d=C.tags?r(C.tags):a,this.each(function(){var c,n=m(this),a=this,r=!1,i=!1,u=[],l={position:0,tag:""},g=document.createElement(C.tagContainer);function s(e,t){C.delay?(a.timer&&clearTimeout(a.timer),a.timer=setTimeout(function(){o(e,t)},C.delay)):o(e,t)}function o(t,a){u=t.value.split(C.separator);var r,s="",n={},o=!(c=[]);for(l={position:currentTags.length-1,tag:""},r=0;r<currentTags.length&&r<u.length;r++)o||currentTags[r].toLowerCase()==u[r].toLowerCase()||(l={position:r,tag:u[r].toLowerCase()},o=!0),n[currentTags[r].toLowerCase()]=!0;if(l.tag){if(C.url)m.ajax({url:C.url,dataType:"json",data:{tag:l.tag},async:!1,success:function(e){c=e}});else{for(r=j=Math.ceil(d.length/2),e=l.tag.length;1<j;)j=Math.ceil(j/2),r=0<=d[r].substr(0,e).localeCompare(l.tag)?Math.max(r-j,0):Math.min(r+j,d.length-1);for(r=r;r<d.length;r++)if(0===d[r].indexOf(l.tag))c.push(d[r]);else if(0<d[r].substr(0,e).localeCompare(l.tag))break}for(c=m.grep(c,function(e,t){return!n[e.toLowerCase()]}),C.sort&&(c=c.sort()),r=0;r<c.length;r++)s+="<"+C.tagWrap+' class="_tag_suggestion">'+c[r]+"</"+C.tagWrap+">";m("span.tagMatches").css("display","block"),g.html(s),i=!!c.length}else f(),m("span.tagMatches").css("display","none")}function f(){g.empty(),i=!(c=[])}function p(){var e=n.val();e==n.attr("title")&&n.is(".hint")&&(e=""),currentTags=e.split(C.separator),f()}function h(e){var t;for(t=0;t<currentTags.length;t++)if(currentTags[t].toLowerCase()!=u[t].toLowerCase()){t;break}if(e=Encoder.htmlDecode(e),C.quoteSpecial){var a=!1,r=["&","|","!",",","(",")",'"',"`","'"," "];for(var s in r)if(0<=e.indexOf(r[s])){a=!0;break}a&&(e='"'+(e+"").replace(/[\\"']/g,"\\$&").replace(/\u0000/g,"\\0")+'"')}u[t]=e,n.val(u.join(C.separator)+C.separator),n.blur().focus(),p()}function t(e){r=!1;var t=e.type,a=!1;switch(e.keyCode){case 37:case 38:case 39:case 40:return f(),!0;case 224:case 17:case 16:case 18:return!0;case 8:if(""==this.value)return f(),p(),!0;t="keyup",a=!0,s(this);break;case 9:case 13:return!i||(h(c[0]),!(r=!0));case 27:return f(),p(),!0;case 32:return p(),!0}if("keyup"==t){switch(e.charCode){case 9:case 13:return!0}a&&p(),s(this,e.charCode)}}n.after(g).keypress(t).keyup(t).blur(function(){(1==r||i)&&(r=!1,n.focus())}),g=m(g).click(function(e){e.target.nodeName==C.tagWrap.toUpperCase()&&m(e.target).is("._tag_suggestion")&&h(e.target.innerHTML)}).addClass(C.matchClass),p()})}}(jQuery);